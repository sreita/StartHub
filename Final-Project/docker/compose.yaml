services:
  # --- BASE DE DATOS  ---
  db:
    image: mysql:8.0
    container_name: starthub-db
    restart: always
    environment:
      MYSQL_DATABASE: starthub_db
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3307:3306"
    volumes:
      - db_data:/var/lib/mysql
      # Cargar scripts
      - ../Database/schema/schema.sql:/docker-entrypoint-initdb.d/01_schema.sql
      - ../Database/seeds/seed_users.sql:/docker-entrypoint-initdb.d/02_users.sql
      - ../Database/seeds/seed_categories.sql:/docker-entrypoint-initdb.d/03_categories.sql
      - ../Database/seeds/seed_startups.sql:/docker-entrypoint-initdb.d/04_startups.sql
      - ../Database/seeds/seed_partnerships.sql:/docker-entrypoint-initdb.d/05_partnerships.sql
      - ../Database/seeds/seed_votes.sql:/docker-entrypoint-initdb.d/06_votes.sql
      - ../Database/seeds/seed_comments.sql:/docker-entrypoint-initdb.d/07_comments.sql
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost", "-u", "root", "-proot"]
      timeout: 20s
      retries: 10

  # --- MAILHOG---
  mailhog:
    image: mailhog/mailhog
    container_name: starthub-mailhog
    ports:
      - "1025:1025"
      - "8025:8025"

  # --- BACKEND FASTAPI ---
  fastapi:
    build: ../services/fastapi
    container_name: starthub-fastapi
    restart: on-failure:5
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8000:8000"
    environment:
      # Conexi√≥n ajustada a MySQL
      DATABASE_URL: mysql+mysqlconnector://root:root@db:3306/starthub_db
      DB_HOST: db
      APP_DEBUG: "true"

  # --- BACKEND SPRING BOOT ---
  spring-auth:
    build: ../services/spring-auth
    container_name: starthub-spring
    restart: on-failure:5
    depends_on:
      db:
        condition: service_healthy
      mailhog:
        condition: service_started
    ports:
      - "8081:8081"
    environment:
      SERVER_PORT: 8081
      DB_URL: jdbc:mysql://db:3306/starthub_db?allowPublicKeyRetrieval=true&useSSL=false
      DB_USERNAME: root
      DB_PASSWORD: root
      SPRING_MAIL_HOST: mailhog
      SPRING_MAIL_PORT: 1025

  # --- FRONTEND ---
  frontend:
    build: ../frontend
    container_name: starthub-frontend
    depends_on:
      - fastapi
      - spring-auth
    ports:
      - "3000:80"

volumes:
  db_data: